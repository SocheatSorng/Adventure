(function () {
    window.handleLateEvents = function (playerIndex, position, targetCell, params) {
        const stats = params.inventory.getStats(playerIndex);
        let message = '';
        const GF = window.GameFunctions;

        // Calculate grid number
        const gridNumber = position + 1;

        // Helper that uses GameFunctions.checkHealth
        function localCheckHealth() {
            return GF.checkHealth(stats, params.playerPositions, playerIndex, targetCell, params.cellOccupancy, params.TOTAL_CELLS);
        }

        switch (gridNumber) {
            case 33: // City of Gold
                const cityGold = Math.floor(Math.random() * 300) + 200;
                params.inventory.modifyGold(playerIndex, cityGold);
                message = `Welcome to the City of Gold! Found ${cityGold} üí∞! `;
                GF.showGoldAnimation(targetCell, cityGold);
                break;

            case 34: // Luck Potion
                GF.createChoiceUI(
                    'You found a luck potion! üß™',
                    [
                        'DRINK - Gain üçÄ',
                        'SELL - Get 500 üí∞',
                    ],
                    (choice) => {
                        switch (choice) {
                            case '1': // DRINK
                                params.inventory.modifyStat(playerIndex, 'luck', 1);
                                message = 'Drank the luck potion! Gained luck üçÄ';
                                break;
                            case '2': // SELL
                                params.inventory.modifyGold(playerIndex, 500);
                                message = 'Sold the luck potion for 500 Gold üí∞';
                                GF.showGoldAnimation(targetCell, 500);
                                break;
                        }
                        GF.showEventMessage(message);
                        params.updatePlayerStats(playerIndex);
                        params.updateGoldDisplay(playerIndex);
                    }
                )
                break;

            case 35: // Pickpocket
                GF.createChoiceUI(
                    `A pickpocket is trying to steal your üí∞!${stats.hasClover ? '\nYou have a Lucky Clover! üçÄ' : ''}`,
                    [
                        'CATCH - Roll dice to catch',
                        'USE üçÄ - Prevent theft'
                    ].filter(Boolean),
                    (choice) => {
                        switch (choice) {
                            case '1': // CATCH
                                const dexRoll = params.rollDice();
                                if (dexRoll >= 5) {
                                    message = `Rolled ${dexRoll}! Caught the pickpocket! ü¶π‚Äç‚ôÇÔ∏è‚ùå`;
                                } else {
                                    const stolenAmount = Math.min(300, params.inventory.getGold(playerIndex));
                                    params.inventory.modifyGold(playerIndex, -stolenAmount);
                                    message = `Rolled ${dexRoll}! Pickpocket stole ${stolenAmount} gold! ü¶π‚Äç‚ôÇÔ∏èüí∞`;
                                    params.inventory.modifyGold(playerIndex, -stolenAmount);
                                }
                                break;
                            case '2': // USE CLOVER
                                if (stats.hasClover) {
                                    stats.hasClover = false;
                                    params.inventory.markItemAsUsed(playerIndex, 'clover');
                                    message = 'Your Lucky Clover wards off the pickpocket! üçÄ';
                                }
                                break;
                        }
                        GF.showEventMessage(message);
                        params.updatePlayerStats(playerIndex);
                        params.updateGoldDisplay(playerIndex);
                    }
                );
                break;

            case 36: // Noble's job
                if (stats.hasAlly) {
                    params.inventory.modifyGold(playerIndex, 1200);
                    message = 'Your ally helped complete the job! Earned 1200 üí∞ from the noble!';
                    GF.showGoldAnimation(targetCell, 1200);
                } else {
                    params.inventory.modifyGold(playerIndex, 800);
                    message = 'Completed a job for a noble! Earned 800 üí∞ üëë';
                    GF.showGoldAnimation(targetCell, 800);
                }
                break;

            case 37: // Buy house
                GF.createChoiceUI(
                    'You found a house for sale! üè†',
                    [
                        'BUY - 1000 Gold',
                        'DECLINE - Save your gold'
                    ],
                    (choice) => {
                        switch (choice) {
                            case '1': // BUY
                                if (params.inventory.getGold(playerIndex) >= 1000) {
                                    params.inventory.modifyGold(playerIndex, -1000);
                                    stats.hasHouse = true;
                                    if (!stats.hasHouse) {
                                        stats.hasHouse = true;
                                        message = 'Bought a house! üè†';
                                        const houseAnimation = document.createElement('div');
                                        houseAnimation.className = 'house-animation';
                                        houseAnimation.innerHTML = 'üè†';
                                        targetCell.appendChild(houseAnimation);
                                        setTimeout(() => houseAnimation.remove(), 3000);
                                    }
                                } else {
                                    message = 'Not enough gold to buy a house üè†‚ùå';
                                }
                                break;
                            default: // DECLINE
                                message = 'Declined to buy the house üè†';
                                break;
                        }
                        GF.showEventMessage(message);
                        params.updatePlayerStats(playerIndex);
                        params.updateGoldDisplay(playerIndex);
                    }
                );
                break;

            case 38: // Dangerous mission
                GF.createChoiceUI(
                    `You are offered a dangerous mission! ‚öîÔ∏è\n` +
                    `Your Strength: ${stats.strength}\n` +
                    `Required: 5 üí™\n` +
                    (stats.hasAlly ? 'Your ally can help complete the mission!\n' : ''),
                    [
                        'Accept mission',
                        'Decline mission'
                    ],
                    (choice) => {
                        if (choice === '1') {
                            if (stats.hasAlly) {
                                // Complete mission with ally's help
                                stats.hasAlly = false;
                                params.inventory.modifyGold(playerIndex, 2000);
                                message = 'Your ally helped complete the mission but had to part ways! +2000 üí∞ -1 ü§ù';
                                GF.showGoldAnimation(targetCell, 2000);
                            } else if (stats.strength >= 5) {
                                // Move forward to Arena Battle
                                params.playerPositions[playerIndex] = 39; // Index 39 = Grid 40
                                const arenaCell = document.querySelector(`#gameTable tr:nth-child(${Math.floor(39/8) + 1}) td:nth-child(${39%8 + 1})`);
                                const token = targetCell.querySelector(`.player${playerIndex + 1}`);
                                if (token && arenaCell) {
                                    arenaCell.appendChild(token);
                                    token.style.top = '50%';
                                    token.style.left = '50%';
                                }
                                message = 'Your strength impressed them! Moving to the Arena Battle! ‚öîÔ∏è';
                            } else {
                                // Move back to Pickpocket
                                params.playerPositions[playerIndex] = 34; // Index 34 = Grid 35
                                const pickpocketCell = document.querySelector(`#gameTable tr:nth-child(${Math.floor(34/8) + 1}) td:nth-child(${34%8 + 1})`);
                                const token = targetCell.querySelector(`.player${playerIndex + 1}`);
                                if (token && pickpocketCell) {
                                    pickpocketCell.appendChild(token);
                                    token.style.top = '50%';
                                    token.style.left = '50%';
                                }
                                message = 'Mission too dangerous! Moved back to grid 35 üèÉ';
                            }
                        } else {
                            message = 'Declined the dangerous mission üõ°Ô∏è';
                        }
                        GF.showEventMessage(message);
                        params.updatePlayerStats(playerIndex);
                        params.updateGoldDisplay(playerIndex);
                    }
                );
                return; // Exit early due to async nature

            case 39: // Guards arrest
                GF.createChoiceUI(
                    'Guards are arresting you! üëÆ',
                    [
                        'PAY - 500 Gold to bribe guards',
                        'FIGHT - Fight guards (Strength 5)',
                        'SURRENDER - Return to start'
                    ],
                    (choice) => {
                        switch (choice) {
                            case '1': // PAY
                                if (params.inventory.getGold(playerIndex) >= 500) {
                                    params.inventory.modifyGold(playerIndex, -500);
                                    message = 'Paid the guards 500 Gold to avoid arrest üí∞';
                                } else {
                                    message = 'Not enough gold to bribe! Guards take you to jail üöì';
                                    GF.sendPlayerToStart(playerIndex, params.playerPositions, targetCell, params.cellOccupancy, params.TOTAL_CELLS);
                                }
                                break;
                            case '2': // FIGHT
                                if (stats.strength >= 5) {
                                    message = 'Successfully fought off the guards! üí™';
                                    stats.strength++;
                                } else {
                                    const newPosition = Math.max(0, params.playerPositions[playerIndex] - 5);
                                    GF.sendPlayerToStart(playerIndex, params.playerPositions, targetCell, params.cellOccupancy, params.TOTAL_CELLS);
                                    message = 'Lost the fight! Moved back 5 spaces üèÉ';
                                }
                                break;
                            default: // SURRENDER
                                GF.sendPlayerToStart(playerIndex, params.playerPositions, targetCell, params.cellOccupancy, params.TOTAL_CELLS);
                                message = 'Surrendered to the guards! Back to start üöì';
                                break;
                        }
                        GF.showEventMessage(message);
                        params.updatePlayerStats(playerIndex);
                        params.updateGoldDisplay(playerIndex);
                    }
                )
                break;

            case 40: // Arena Battle
                GF.createChoiceUI(
                    `Arena Battle Challenge! ‚öîÔ∏è\n`,
                    [
                        'FIGHT - Roll dice for glory',
                        'DECLINE - Return to start',
                        stats.potions ? 'USE POTION - Auto win' : null
                    ].filter(Boolean),
                    (choice) => {
                        switch (choice) {
                            case '1': // FIGHT
                                const battleRoll = params.rollDice();
                                if (battleRoll >= 6) {
                                    params.inventory.modifyGold(playerIndex, 2000);
                                    stats.strength++;
                                    message = `Arena victory! Rolled ${battleRoll}! Won 2,000 Gold and +1 Strength üèÜ`;
                                    GF.showGoldAnimation(targetCell, 2000);
                                } else {
                                    // Send player back to start
                                    GF.sendPlayerToStart(playerIndex, params.playerPositions, targetCell, params.cellOccupancy, params.TOTAL_CELLS);
                                    message = `Arena defeat! Rolled ${battleRoll}! Back to start ‚öîÔ∏è`;
                                }
                                break;
                            case '2': // DECLINE
                                GF.sendPlayerToStart(playerIndex, params.playerPositions, targetCell, params.cellOccupancy, params.TOTAL_CELLS);
                                message = 'Declined the arena battle. Back to start ‚öîÔ∏è';
                                break;
                            case '3': // USE POTION
                                if (stats.potions) {
                                    stats.potions--;
                                    params.inventory.modifyGold(playerIndex, 2000);
                                    stats.strength++;
                                    message = 'Used potion to win! +2,000 üí∞ and +1 üí™ üß™üèÜ';
                                    GF.showGoldAnimation(targetCell, 2000);
                                }
                                break;
                        }
                        GF.showEventMessage(message);
                        params.updatePlayerStats(playerIndex);
                        params.updateGoldDisplay(playerIndex);
                    }
                );
                break;

            case 41: // Secret treasure room
                const treasureBonus = stats.hasClue ? 500 : 0;
                params.inventory.modifyGold(playerIndex, 1000 + treasureBonus);
                message = `Found a secret treasure room! +${1000 + treasureBonus} üí∞`;
                GF.showGoldAnimation(targetCell, 1000 + treasureBonus);
                break;

            case 42: // Clue to final goal
                stats.hasClue = true;
                message = 'Found a clue about the Golden Crown! Future choices will be clearer üìú';
                const clueAnimation = document.createElement('div');
                clueAnimation.className = 'map-animation';
                clueAnimation.innerHTML = 'üìú';
                targetCell.appendChild(clueAnimation);
                setTimeout(() => clueAnimation.remove(), 1000);
                break;

            case 43: // Crime Lord's deal
                GF.createChoiceUI(
                    'You met the Crime Lord! üí∞',
                    [
                        'ACCEPT - 1,000 Gold but gained bad karma',
                        'REFUSE - Keep your honor'
                    ],
                    (choice) => {
                        switch (choice) {
                            case '1': // ACCEPT
                                params.inventory.modifyGold(playerIndex, 1000);
                                message = 'Accepted dark deal! +1,000 üí∞, +üòà';
                                stats.devil = true;
                                GF.showGoldAnimation(targetCell, 1000);
                                break;
                            default: // REFUSE
                                stats.karma = (stats.karma || 0) + 1;
                                message = 'Refused the Crime Lord. +üòá';
                                stats.angel = true;
                                break;
                        }
                        GF.showEventMessage(message);
                        params.updatePlayerStats(playerIndex);
                        params.updateGoldDisplay(playerIndex);
                    }
                )
                break;

            case 44: // Wizard's teleport
                if (stats.magic >= 3) {
                    const oldPos = params.playerPositions[playerIndex];
                    let stepsForward = 1;  // Default 1 step for having >= 3 magic
                    
                    if (stats.hasWand) {
                        // With wand: moves based on magic amount (max 10)
                        stepsForward = Math.min(stats.magic, 10);
                        message = `ü™Ñ amplifies your magic! Moving ${stepsForward} steps forward! ü™Ñ‚ú®`;
                        stats.hasWand = false;
                    } else {
                        message = `Used magic to move 1 step forward! ‚ú®`;
                    }
            
                    const newPos = Math.min(oldPos + stepsForward, params.TOTAL_CELLS - 1);
                    
                    // Update cell occupancy and move token
                    params.cellOccupancy[oldPos]--;
            
                    const targetRow = Math.floor(newPos / 8);
                    const targetCol = newPos % 8;
                    const newCell = document.querySelector(`#gameTable tr:nth-child(${targetRow + 1}) td:nth-child(${targetCol + 1})`);
                    const token = targetCell.querySelector(`.player${playerIndex + 1}`);
            
                    if (token && newCell) {
                        newCell.appendChild(token);
                        token.style.top = '50%';
                        token.style.left = '50%';
                        params.cellOccupancy[newPos]++;
                    }
            
                    params.playerPositions[playerIndex] = newPos;
                } else {
                    message = 'Not enough üîÆ to cast teleport! Need at least 3 üîÆ‚ùå';
                }
                GF.showEventMessage(message);
                break;

            case 45: // Royal Feast
                stats.health++;
                if (stats.angel > 0) {
                    message = 'Attended a Royal Feast! Health +3';
                    stats.health += 3;
                } else if (stats.devil > 0) {
                    message = 'Attended a Royal Feast! Health -3';
                    stats.health -= 3;
                }
                break;

            case 46: // Queen's Secret Mission
                GF.createChoiceUI(
                    'The Queen offers you a secret mission! üëë',
                    [
                        'ACCEPT - Risk health for 2,500 Gold',
                        'DECLINE - Keep your health'
                    ],
                    (choice) => {
                        switch (choice) {
                            case '1': // ACCEPT
                                const missionRoll = params.rollDice() + (stats.luck || 0);
                                if (missionRoll >= 4) {
                                    params.inventory.modifyGold(playerIndex, 2500);
                                    message = 'Mission successful! Earned 2,500 Gold üéØ';
                                    GF.showGoldAnimation(targetCell, 2500);
                                } else {
                                    stats.health--;
                                    message = localCheckHealth() || 'Mission failed! Lost 1 health ‚ùå';
                                }
                                break;
                            default: // DECLINE
                                message = 'Declined the Queen\'s mission üèÉ';
                                break;
                        }
                        GF.showEventMessage(message);
                        params.updatePlayerStats(playerIndex);
                        params.updateGoldDisplay(playerIndex);
                    }
                )
                break;

            case 47: // Secret Society
                GF.createChoiceUI(
                    'You found a secret society! üåå',
                    [
                        'JOIN - Light Society (+2 Magic)',
                        'JOIN - Dark Society (+2 Strength)',
                        'DECLINE - Stay neutral'
                    ],
                    (choice) => {
                        switch (choice) {
                            case '1': // JOIN LIGHT
                                stats.alignment = 'light';
                                stats.magic = (stats.magic || 0) + 2;
                                message = 'Joined the Light Society! Magic +2 ‚ú®';
                                break;
                            case '2': // JOIN DARK
                                stats.alignment = 'dark';
                                stats.strength += 2;
                                stats.magic = Math.max(0, (stats.magic || 0) - 1); // Reduce magic when choosing strength
                                message = 'Joined the Dark Society! Strength +2, Magic -1 ‚öîÔ∏è';
                                break;
                            default: // DECLINE
                                message = 'Declined to join any society üö∂';
                                break;
                        }
                        GF.showEventMessage(message);
                        params.updatePlayerStats(playerIndex);
                    }
                )
                break;

            case 48: // City in Chaos
                if (stats.hasAlly) {
                    message = 'Your ally helped you escape the chaos safely! ü§ù';
                    stats.hasAlly = false; // Ally leaves after helping
                    params.inventory.markItemAsUsed(playerIndex, 'ally');
                } else {
                    // Send player back to start
                    GF.sendPlayerToStart(playerIndex, params.playerPositions, targetCell, params.cellOccupancy, params.TOTAL_CELLS);
                    message = 'Got caught in the chaos! Back to start! üå™Ô∏è';
                }
                GF.showEventMessage(message);
                params.updatePlayerStats(playerIndex);
                break;

            case 49: // Dark Warrior
                const darkWarriorInfo = `Current Stats:\nStrength: ${stats.strength}\nHealth: ${stats.health}\n\n`;
                const warriorChoice = confirm(
                    darkWarriorInfo +
                    'Dark Warrior challenges you!\nRequired Strength: 7\nAccept duel? ‚öîÔ∏è'
                );

                if (warriorChoice) {
                    const duelRoll = params.rollDice();
                    const totalPower = duelRoll + (stats.strength || 0);
                    if (totalPower >= 7) {
                        stats.honor = (stats.honor || 0) + 1;
                        stats.strength += 1;
                        message = 'Victory! Honor +1, Strength +1 ‚öîÔ∏èüëë';
                    } else {
                        params.playerPositions[playerIndex] = Math.max(0, params.playerPositions[playerIndex] - 3);
                        message = 'Lost the duel! Retreated 3 spaces üèÉ';
                    }
                } else {
                    message = 'Declined the duel with the Dark Warrior üõ°Ô∏è';
                }
                break;

            case 50: // Haunted Castle
                const ghostRoll = params.rollDice() + (stats.magic || 0);
                const requiredPower = 5;
                const currentPower = ghostRoll;

                if (currentPower >= requiredPower) {
                    if (stats.hasClue) {
                        stats.hasSecrets = true;
                        message = 'The ghosts reveal ancient secrets about the Golden Crown! üëªüìú';
                        const secretAnimation = document.createElement('div');
                        secretAnimation.className = 'map-animation';
                        secretAnimation.innerHTML = 'üìú';
                        targetCell.appendChild(secretAnimation);
                        setTimeout(() => secretAnimation.remove(), 1000);
                    } else {
                        message = `Survived the haunted castle! (Roll: ${ghostRoll}, Magic: ${stats.magic || 0}, Total: ${currentPower}/${requiredPower}) üëª`;
                    }
                } else {
                    stats.health--;
                    stats.cursed = true;
                    const lostItems = [];
                    if (stats.potions > 0) {
                        lostItems.push(`${stats.potions} potions`);
                        stats.potions = 0;
                    }
                    if (stats.magic > 0) {
                        lostItems.push('1 magic');
                        stats.magic = Math.max(0, stats.magic - 1);
                    }
                    const lostMessage = lostItems.length > 0 ? ` Lost ${lostItems.join(' and ')}!` : '';
                    message = localCheckHealth() || `The ghosts cursed you! Roll: ${ghostRoll}, Magic: ${stats.magic || 0}, Total: ${currentPower}/${requiredPower}. Lost 1 health and became cursed!${lostMessage} üëªüíÄ`;
                }
                break;

            case 51: // Dungeon Trapdoor
                GF.createChoiceUI(
                    'You fell into a dungeon! üï≥Ô∏è',
                    [
                        'EXPLORE - Risk health for treasure',
                        'HIDE - Stay safe (Luck helps)',
                        'CALL - Get help (Move back)'
                    ],
                    (choice) => {
                        switch (choice) {
                            case '1': // EXPLORE
                                const dungeonRoll = params.rollDice() + (stats.luck || 0);
                                if (dungeonRoll >= 4) {
                                    params.inventory.modifyGold(playerIndex, 800);
                                    message = 'Found hidden treasure! +800 Gold üí∞';
                                    GF.showGoldAnimation(targetCell, 800);
                                } else {
                                    stats.health--;
                                    message = localCheckHealth() || 'Encountered enemies! Lost 1 health ‚öîÔ∏è';
                                }
                                break;
                            case '2': // HIDE
                                if (stats.luck && stats.luck > 2) {
                                    stats.hasAlly = true;
                                    message = 'Found a friendly prisoner who becomes your ally! ü§ù';
                                } else {
                                    message = 'Successfully avoided danger üõ°Ô∏è';
                                }
                                break;
                            default: // CALL or invalid input
                                params.playerPositions[playerIndex] = Math.max(0, params.playerPositions[playerIndex] - 2);
                                message = 'Guards heard you! Moved back 2 spaces üëÆ';
                                break;
                        }
                        GF.showEventMessage(message);
                        params.updatePlayerStats(playerIndex);
                        params.updateGoldDisplay(playerIndex);
                    }
                );
                break;

            case 52: // Mystic Staff
                const staffAnimation = document.createElement('div');
                staffAnimation.className = 'map-animation';
                staffAnimation.innerHTML = 'üîÆ';
                targetCell.appendChild(staffAnimation);
                setTimeout(() => staffAnimation.remove(), 1000);

                stats.magic = (stats.magic || 0) + 3;
                stats.hasMysticStaff = true;
                message = 'Found the Mystic Staff! Magic +3 üîÆ';
                if (stats.alignment === 'light') {
                    stats.magic++;
                    message += ' Light alignment bonus: Magic +1 ‚ú®';
                }
                break;

            case 53: // Demon's Deal
                const demonInfo = `Current Status:\nGold: ${params.inventory.getGold(playerIndex)}\nKarma: ${stats.karma || 0}\n\n`;
                if (confirm(demonInfo + 'Accept demon\'s deal?\n2,000 Gold for -2 karma üòà')) {
                    params.inventory.modifyGold(playerIndex, 2000);
                    stats.karma = (stats.karma || 0) - 2;
                    stats.soulBound = true;
                    message = 'Accepted demon\'s deal. +2,000 Gold but soul is bound üòàüí∞';
                    GF.showGoldAnimation(targetCell, 2000);
                } else if (stats.alignment === 'light') {
                    message = 'Rejected demon. Light alignment rewarded with +1 strength ‚ú®üí™';
                    stats.strength++;
                } else {
                    message = 'Rejected demon\'s offer üõ°Ô∏è';
                }
                break;

            case 54: // Rival Chase
                const mapStatus = stats.hasMap ? 'Map was stolen!' : 'Rival has a map!';
                const chaseChoice = prompt(
                    `${mapStatus} üó∫Ô∏è\n` +
                    'CHASE: Need Strength 4+\n' +
                    'BRIBE: Cost 300 Gold\n' +
                    'CONTINUE: Move on\n' +
                    'Type your choice:'
                )?.toUpperCase();

                switch (chaseChoice) {
                    case 'CHASE':
                        if (stats.strength >= 4) {
                            stats.hasMap = true;
                            stats.strength++;
                            message = 'Caught the thief! Recovered map and gained strength üí™';
                        } else {
                            params.playerPositions[playerIndex] = Math.max(0, params.playerPositions[playerIndex] - 4);
                            message = 'Failed to catch thief! Moved back 4 spaces üèÉ';
                        }
                        break;
                    case 'BRIBE':
                        if (params.inventory.getGold(playerIndex) >= 300) {
                            params.inventory.modifyGold(playerIndex, -300);
                            stats.hasMap = true;
                            stats.hasAlly = true;
                            message = 'Paid thief 300 Gold. They become your ally! ü§ù';
                        } else {
                            message = 'Not enough gold to bribe üí∞‚ùå';
                        }
                        break;
                    default:
                        stats.hasMap = false;
                        message = 'Continued without the map üö∂';
                        break;
                }
                break;

            case 55: // Mysterious Portal
                const portalInfo = `Current Status:\nClues: ${stats.hasClue ? 'Yes' : 'No'}\nSecrets: ${stats.hasSecrets ? 'Yes' : 'No'}\n\n`;
                const portalChoice = confirm(portalInfo + 'Enter the mysterious portal? üåÄ');

                if (portalChoice) {
                    if (stats.hasClue || stats.hasSecrets) {
                        const advance = Math.floor(Math.random() * 6) + 3;
                        setTimeout(() => params.movePlayer(playerIndex, advance), 500);
                        message = `Your knowledge guided you! Moving forward ${advance} spaces ‚ú®`;
                    } else {
                        params.playerPositions[playerIndex] = Math.max(0, params.playerPositions[playerIndex] - 5);
                        message = 'Portal sent you backward! Moved back 5 spaces üåÄ';
                    }
                } else {
                    message = 'Wisely avoided the unstable portal üõ°Ô∏è';
                }
                break;

            case 56: // Final Guardian
                const guardianInfo = `Your Power:\nStrength: ${stats.strength}\nMagic: ${stats.magic || 0}\nMystic Staff: ${stats.hasMysticStaff ? 'Yes' : 'No'}\n\n`;

                if (!stats.foughtGuardian) {
                    const guardianBattle = stats.strength + (stats.magic || 0) + params.rollDice();
                    if (guardianBattle >= 10 || stats.hasMysticStaff) {
                        stats.foughtGuardian = true;
                        stats.honor = (stats.honor || 0) + 2;
                        message = 'Defeated the Final Guardian! Honor +2 üëë‚öîÔ∏è';
                    } else {
                        params.playerPositions[playerIndex] = Math.max(0, params.playerPositions[playerIndex] - 6);
                        message = 'Guardian overwhelmed you! Moved back 6 spaces üõ°Ô∏è';
                    }
                } else {
                    message = 'The Guardian recognizes your previous victory ‚ú®';
                }
                break;

            case 29: // Dragon encounter
                const dragonChoice = confirm(
                    `A fierce dragon blocks your path! üê≤\n` +
                    `Your Strength: ${stats.strength}\n` +
                    `Required Strength: 6\n` +
                    `Current Gold: ${params.inventory.getGold(playerIndex)}\n` +
                    (stats.hasAlly ? 'You have an ally! They can help you fight!\n' : '') +
                    `Bribe Cost: 500\n\n` +
                    `Fight the dragon? (OK to fight, Cancel to bribe)`
                );

                if (dragonChoice) {
                    if (stats.hasAlly && confirm('Use your ally to help fight the dragon? ü§ù')) {
                        params.inventory.markItemAsUsed(playerIndex, 'ally');
                        message = 'You and your ally defeated the dragon! üê≤‚öîÔ∏è';
                        stats.strength += 2;
                    } else if (stats.strength >= 6) {
                        message = 'You defeated the dragon with your strength! üê≤‚öîÔ∏è';
                        stats.strength += 2;
                    } else {
                        params.playerPositions[playerIndex] = 0;
                        message = 'The dragon was too powerful! Back to start üê≤';
                    }
                } else if (params.inventory.getGold(playerIndex) >= 500) {
                    params.inventory.modifyGold(playerIndex, -500);
                    message = 'Bribed the dragon with 500 Gold to pass safely üê≤üí∞';
                } else {
                    params.playerPositions[playerIndex] = 0;
                    message = 'Not enough gold to bribe! Back to start üê≤';
                }
                break;
        }

        return message;
    };
})();